---

- name: Install updates
  ansible.builtin.dnf:
    name: "*"
    state: latest
    update_cache: true
  register: dnf_update_result

- name: Reboot
  ansible.builtin.reboot:
  when: dnf_update_result.changed

- name: Disable SWAP
  ansible.builtin.shell: swapoff -a

- name: Disable SWAP in fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^(?!#)(.+swap.*)$'
    replace: '# \1'
    backup: yes

- name: Disable firewalld
  ansible.builtin.systemd:
    name: firewalld 
    state: stopped 
    enabled: no
    
- name: Put SELinux in permissive mode, logging actions that would be blocked.
  ansible.posix.selinux:
    policy: targeted
    state: permissive

- name: Enable IPv4 packet forwarding
  ansible.builtin.blockinfile:
    path: /etc/sysctl.d/k8s.conf
    create: yes
    block: net.ipv4.ip_forward = 1
  register: packet_forwarding_result

- name: Apply sysctl params without reboot
  ansible.builtin.command: sysctl --system
  when: packet_forwarding_result.changed